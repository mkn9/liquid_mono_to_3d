#!/bin/bash
# Pre-commit hook for parallel branch development
# Prevents commits that violate component/branch specifications

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "ğŸ” Pre-commit: Checking parallel development compliance..."

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check if .required_branches exists
if [ -f .required_branches ]; then
    # Check if current branch is in required branches
    if ! grep -q "^${CURRENT_BRANCH}$" .required_branches; then
        echo -e "${YELLOW}âš  Warning: Current branch '$CURRENT_BRANCH' not in .required_branches${NC}"
        echo -e "${YELLOW}  This may be intentional (e.g., feature branch)${NC}"
    fi
fi

# Check if component spec exists
if [ -f .component_spec.yaml ]; then
    echo "  â†’ Checking component claims..."
    
    # Get staged files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
    
    if [ -n "$STAGED_FILES" ]; then
        # Check for forbidden patterns
        FORBIDDEN_FOUND=0
        
        for file in $STAGED_FILES; do
            # Check for "simplified", "fake", "TODO: implement" patterns
            if grep -qE '# (simplified|fake|placeholder|TODO.*implement).*(magvit|clip|gpt|mistral|phi|i3d|slowfast)' "$file" 2>/dev/null; then
                echo -e "${RED}âœ— Found forbidden pattern in $file${NC}"
                grep -nE '# (simplified|fake|placeholder|TODO.*implement).*(magvit|clip|gpt|mistral|phi|i3d|slowfast)' "$file" | head -3
                FORBIDDEN_FOUND=1
            fi
            
            # Check for SimplifiedXXX class names
            if grep -qE 'class\s+Simplified(MAGVIT|CLIP|I3D|SlowFast)' "$file" 2>/dev/null; then
                echo -e "${RED}âœ— Found 'Simplified' class name in $file${NC}"
                grep -nE 'class\s+Simplified(MAGVIT|CLIP|I3D|SlowFast)' "$file"
                FORBIDDEN_FOUND=1
            fi
        done
        
        if [ $FORBIDDEN_FOUND -eq 1 ]; then
            echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${RED}âœ— COMMIT BLOCKED: Forbidden patterns detected${NC}"
            echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo "Forbidden patterns indicate fake/simplified implementations:"
            echo "  - Comments with 'simplified', 'fake', 'placeholder'"
            echo "  - 'TODO: implement' for required components"
            echo "  - Class names like 'SimplifiedMAGVIT'"
            echo ""
            echo "Either:"
            echo "  1. Remove the fake implementation and use real component"
            echo "  2. Rename to accurately reflect what it is (e.g., 'Basic3DCNN')"
            echo "  3. Add to exception list if this is intentional"
            echo ""
            exit 1
        fi
    fi
    
    echo -e "  ${GREEN}âœ“ No forbidden patterns found${NC}"
fi

# Check branch-specific directory structure
BRANCH_DIR=$(echo "$CURRENT_BRANCH" | sed 's|.*/||' | tr '-' '_')

if [ -n "$BRANCH_DIR" ] && [ "$BRANCH_DIR" != "main" ] && [ "$BRANCH_DIR" != "master" ]; then
    # Check if branch has its own directory
    if [ ! -d "$BRANCH_DIR" ]; then
        echo -e "${YELLOW}âš  Warning: No branch-specific directory found: $BRANCH_DIR/${NC}"
        echo -e "${YELLOW}  Consider organizing code in branch-specific directories${NC}"
    fi
fi

echo -e "${GREEN}âœ“ Pre-commit checks passed${NC}"
exit 0

